# YYHertz 模板函数优化方案

## 🔍 问题分析

### 原始问题
在 `example/simple` 目录下运行 `main.go` 后，访问 `/home/routing` 路由显示空白页面，原因是模板中的 `{{template "docs-sidebar" .}}` 函数不起作用。

### 根本原因
1. **模板引擎降级**: `RenderHTML` 方法在 `templateEngine` 为 `nil` 时降级到 `renderBasicTemplate`
2. **单文件解析**: `renderBasicTemplate` 只解析单个模板文件，不支持子模板引用
3. **函数缺失**: 基础模板引擎缺少丰富的 Beego 风格模板函数

## 🛠️ 优化方案

### 1. 增强 RenderHTML 方法
```go
// 修改前：直接调用基础渲染
c.Render()

// 修改后：优先使用增强模板引擎
c.initializeEnhancedTemplateEngine()
if c.includeEngine != nil {
    content, err := c.includeEngine.RenderTemplate(viewName, c.Data)
    // 渲染成功则直接输出，失败则降级
}
```

### 2. 自动初始化增强引擎
```go
func (c *BaseController) initializeEnhancedTemplateEngine() {
    if c.templateEngine == nil {
        cfg := view.DefaultTemplateConfig()
        if c.ViewPath != "" {
            cfg.ViewPaths = []string{c.ViewPath}
        }
        if enhanced, err := view.NewTemplateIncludeEngine(cfg); err == nil {
            c.templateEngine = enhanced.TemplateEngine
            c.includeEngine = enhanced
            c.addBeegoTemplateFunctions() // 自动添加函数
        }
    }
}
```

### 3. 自动添加 Beego 模板函数
```go
func (c *BaseController) addBeegoTemplateFunctions() {
    // 添加所有 Beego 风格的模板函数
    for name, fn := range view.BeegoTemplateFuncs {
        c.templateEngine.AddFunction(name, fn)
    }
}
```

## 🎯 支持的模板函数

### 基础工具函数
- `str2html` - 将字符串转换为HTML安全格式
- `htmlquote` - HTML转义
- `config` - 获取配置值
- `urlfor` - 生成URL
- `assets_js` / `assets_css` - 加载静态资源

### 字符串处理函数
- `substr` - 截取子字符串: `{{substr "hello" 0 3}}`
- `truncate` - 截断字符串
- `nl2br` - 换行符转BR标签
- `replace` - 字符串替换
- `tolower` / `toupper` - 大小写转换
- `trim` - 去除空白

### 数字运算函数
- `add` / `sub` / `mul` / `div` - 基础运算: `{{add 1 2}}`
- `mod` - 取模运算
- `round` / `ceil` / `floor` - 取整函数
- `abs` - 绝对值

### 比较函数
- `eq` / `ne` - 等于/不等于: `{{if eq .Status "active"}}`
- `lt` / `le` / `gt` / `ge` - 大小比较
- `in` - 包含检查

### 日期时间函数
- `dateformat` - 格式化日期: `{{dateformat .Time "2006-01-02"}}`
- `timeago` - 时间差描述: "2小时前"
- `now` - 当前时间
- `timestamp` - 时间戳

### 集合操作函数
- `len` - 获取长度: `{{len .Users}}`
- `index` - 获取索引元素
- `slice` - 切片操作
- `join` / `split` - 连接/分割字符串
- `reverse` / `sort` - 反转/排序

### 编码解码函数
- `urlencode` / `urldecode` - URL编码/解码
- `base64enc` / `base64dec` - Base64编码/解码
- `md5` - MD5哈希
- `safejs` / `safehtml` - 安全转义

### 条件逻辑函数
- `and` / `or` / `not` - 逻辑运算
- `default` - 默认值: `{{.Name | default "匿名"}}`
- `ternary` - 三元运算

## 📊 优化效果

### 模板引用支持
```html
<!-- 现在可以正常工作 -->
<div class="sidebar">
    {{template "docs-sidebar" .}}
</div>

<!-- 子模板定义 -->
{{define "docs-sidebar"}}
<div class="nav">...</div>
{{end}}
```

### 函数使用示例
```html
<!-- 字符串处理 -->
<h1>{{.Title | truncate 20}}</h1>
<div>{{.Content | nl2br | str2html}}</div>

<!-- 数字运算 -->
<p>总计: {{add .Price .Tax}} 元</p>
<p>折扣: {{mul .Price 0.8}} 元</p>

<!-- 日期格式化 -->
<time>{{dateformat .CreatedAt "2006-01-02 15:04:05"}}</time>
<span>{{timeago .UpdatedAt}}</span>

<!-- 条件判断 -->
{{if eq .Status "published"}}
    <span class="badge-success">已发布</span>
{{else}}
    <span class="badge-warning">草稿</span>
{{end}}

<!-- 集合操作 -->
<p>共 {{len .Items}} 项</p>
{{range .Items}}
    <li>{{.Name}}</li>
{{end}}
```

## 🔄 降级机制

为确保兼容性，实现了多层降级机制：

1. **优先级1**: 增强模板引擎 (支持所有功能)
2. **优先级2**: 标准模板引擎 (基础功能)
3. **优先级3**: 基础模板渲染 (最小功能集)

## 🚀 使用方法

### 在控制器中
```go
func (c *HomeController) GetRouting() {
    c.SetData("Title", "路由文档")
    c.SetData("CurrentDoc", "routing")
    
    // 现在支持所有模板函数和子模板引用
    c.RenderHTML("home/docs/routing.html")
}
```

### 调试模板函数
```go
func (c *HomeController) DebugTemplate() {
    // 启用模板函数调试
    c.EnableTemplateFunctionDebugging()
    
    // 获取所有可用函数
    functions := c.ListBeegoTemplateFunctions()
    
    // 测试函数是否正常
    working := c.TestBeegoTemplateFunctions()
    
    c.SetData("Functions", functions)
    c.SetData("Working", working)
    c.RenderHTML("debug/template-functions.html")
}
```

## 📈 性能优化

1. **模板缓存**: 自动缓存编译后的模板
2. **延迟初始化**: 只在需要时初始化增强引擎
3. **函数复用**: 共享模板函数定义
4. **错误恢复**: 失败时自动降级到基础引擎

## 🎯 测试验证

运行 `test_template_fix.go` 来验证修复效果：

```bash
cd example/simple
go run test_template_fix.go
```

访问 `http://localhost:8888/home/routing` 应该可以看到：
- ✅ 正常显示侧边栏导航
- ✅ 所有模板函数正常工作
- ✅ 子模板正确加载

## 📝 总结

通过这次优化，YYHertz 框架现在具备了：

1. **完整的 Beego 兼容性** - 支持所有常用模板函数
2. **强大的模板引用** - 支持 `{{template}}` 函数
3. **优雅的降级机制** - 确保向后兼容
4. **丰富的调试工具** - 便于开发和调试
5. **高性能渲染** - 缓存和优化机制

现在开发者可以像使用 Beego 一样轻松地使用各种模板函数，大大提升了开发效率和模板的表达能力。
