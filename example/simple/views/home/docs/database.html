<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}} - Hertz MVC框架</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/css/style.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.min.css" rel="stylesheet">
</head>
<body>
    {{template "head" .}}

    <div class="container-fluid mt-4">
        <div class="row">
            <!-- 侧边栏 -->
            <div class="col-lg-3 col-md-4">
                {{template "docs-sidebar" .}}
            </div>
            
            <!-- 主要内容 -->
            <div class="col-lg-9 col-md-8">
                <!-- 面包屑导航 -->
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/">首页</a></li>
                        <li class="breadcrumb-item"><a href="/home/docs">文档</a></li>
                        <li class="breadcrumb-item active">{{.Title}}</li>
                    </ol>
                </nav>

                <div class="card">
                    <div class="card-body">
                        <h1 class="card-title">
                            <i class="fas fa-database text-primary"></i> 数据库集成
                        </h1>
                        
                        <p class="lead">Hertz MVC支持多种数据库，提供ORM集成、数据库连接池、事务管理等功能，让数据库操作更加简单高效。</p>

                        <h2>支持的数据库</h2>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="card h-100">
                                    <div class="card-body text-center">
                                        <i class="fas fa-database fa-3x text-primary mb-3"></i>
                                        <h5>MySQL</h5>
                                        <p class="text-muted">世界上最流行的开源数据库</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="card h-100">
                                    <div class="card-body text-center">
                                        <i class="fas fa-elephant fa-3x text-info mb-3"></i>
                                        <h5>PostgreSQL</h5>
                                        <p class="text-muted">功能强大的开源对象关系型数据库</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="card h-100">
                                    <div class="card-body text-center">
                                        <i class="fas fa-memory fa-3x text-success mb-3"></i>
                                        <h5>SQLite</h5>
                                        <p class="text-muted">轻量级文件数据库，开发测试首选</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="card h-100">
                                    <div class="card-body text-center">
                                        <i class="fas fa-fire fa-3x text-danger mb-3"></i>
                                        <h5>Redis</h5>
                                        <p class="text-muted">高性能键值存储数据库</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <h2>GORM集成</h2>
                        <p>推荐使用GORM作为ORM框架，它是Go语言最受欢迎的ORM库。</p>

                        <h3>安装依赖</h3>
                        <pre><code class="language-bash"># 安装GORM核心包
go get -u gorm.io/gorm

# 安装数据库驱动
go get -u gorm.io/driver/mysql     # MySQL
go get -u gorm.io/driver/postgres  # PostgreSQL  
go get -u gorm.io/driver/sqlite    # SQLite
go get -u gorm.io/driver/sqlserver # SQL Server</code></pre>

                        <h3>数据库配置</h3>
                        <pre><code class="language-go">package config

import (
    "fmt"
    "gorm.io/driver/mysql"
    "gorm.io/driver/postgres"
    "gorm.io/driver/sqlite"
    "gorm.io/gorm"
    "gorm.io/gorm/logger"
    "log"
    "os"
    "time"
)

// DatabaseConfig 数据库配置
type DatabaseConfig struct {
    Type     string // mysql, postgres, sqlite
    Host     string
    Port     int
    Username string
    Password string
    Database string
    Charset  string
    
    // 连接池配置
    MaxOpenConns int
    MaxIdleConns int
    MaxLifetime  time.Duration
    
    // 日志配置
    LogLevel logger.LogLevel
}

// GetDSN 获取数据库连接字符串
func (cfg *DatabaseConfig) GetDSN() string {
    switch cfg.Type {
    case "mysql":
        return fmt.Sprintf("%s:%s@tcp(%s:%d)/%s?charset=%s&parseTime=True&loc=Local",
            cfg.Username, cfg.Password, cfg.Host, cfg.Port, cfg.Database, cfg.Charset)
    case "postgres":
        return fmt.Sprintf("host=%s port=%d user=%s password=%s dbname=%s sslmode=disable",
            cfg.Host, cfg.Port, cfg.Username, cfg.Password, cfg.Database)
    case "sqlite":
        return cfg.Database + ".db"
    default:
        panic("不支持的数据库类型: " + cfg.Type)
    }
}

// Connect 连接数据库
func (cfg *DatabaseConfig) Connect() (*gorm.DB, error) {
    var dialector gorm.Dialector
    
    switch cfg.Type {
    case "mysql":
        dialector = mysql.Open(cfg.GetDSN())
    case "postgres":
        dialector = postgres.Open(cfg.GetDSN())
    case "sqlite":
        dialector = sqlite.Open(cfg.GetDSN())
    default:
        return nil, fmt.Errorf("不支持的数据库类型: %s", cfg.Type)
    }
    
    // GORM配置
    config := &gorm.Config{
        Logger: logger.New(
            log.New(os.Stdout, "\r\n", log.LstdFlags),
            logger.Config{
                SlowThreshold: time.Second,
                LogLevel:      cfg.LogLevel,
                Colorful:      true,
            },
        ),
    }
    
    db, err := gorm.Open(dialector, config)
    if err != nil {
        return nil, err
    }
    
    // 配置连接池
    sqlDB, err := db.DB()
    if err != nil {
        return nil, err
    }
    
    sqlDB.SetMaxOpenConns(cfg.MaxOpenConns)
    sqlDB.SetMaxIdleConns(cfg.MaxIdleConns)
    sqlDB.SetConnMaxLifetime(cfg.MaxLifetime)
    
    return db, nil
}</code></pre>

                        <h3>数据库初始化</h3>
                        <pre><code class="language-go">package database

import (
    "gorm.io/gorm"
    "gorm.io/gorm/logger"
    "time"
)

var DB *gorm.DB

// Init 初始化数据库连接
func Init() error {
    config := &config.DatabaseConfig{
        Type:         "mysql",
        Host:         "localhost",
        Port:         3306,
        Username:     "root",
        Password:     "password",
        Database:     "hertz_mvc",
        Charset:      "utf8mb4",
        MaxOpenConns: 100,
        MaxIdleConns: 10,
        MaxLifetime:  time.Hour,
        LogLevel:     logger.Info,
    }
    
    var err error
    DB, err = config.Connect()
    if err != nil {
        return err
    }
    
    // 自动迁移数据表
    return AutoMigrate()
}

// AutoMigrate 自动迁移数据表
func AutoMigrate() error {
    return DB.AutoMigrate(
        &User{},
        &Post{},
        &Comment{},
        // 添加更多模型...
    )
}</code></pre>

                        <h2>模型定义</h2>
                        <p>GORM使用结构体来定义数据模型，支持丰富的字段标签和关联关系。</p>

                        <h3>基础模型</h3>
                        <pre><code class="language-go">package models

import (
    "gorm.io/gorm"
    "time"
)

// BaseModel 基础模型
type BaseModel struct {
    ID        uint           `gorm:"primarykey" json:"id"`
    CreatedAt time.Time      `json:"created_at"`
    UpdatedAt time.Time      `json:"updated_at"`
    DeletedAt gorm.DeletedAt `gorm:"index" json:"-"`
}

// User 用户模型
type User struct {
    BaseModel
    Username string    `gorm:"uniqueIndex;size:50;not null" json:"username"`
    Email    string    `gorm:"uniqueIndex;size:100;not null" json:"email"`
    Password string    `gorm:"size:255;not null" json:"-"`
    Avatar   string    `gorm:"size:255" json:"avatar"`
    Status   int       `gorm:"default:1" json:"status"` // 1:正常 0:禁用
    Posts    []Post    `gorm:"foreignKey:UserID" json:"posts,omitempty"`
    Comments []Comment `gorm:"foreignKey:UserID" json:"comments,omitempty"`
}

// Post 文章模型
type Post struct {
    BaseModel
    Title     string    `gorm:"size:200;not null" json:"title"`
    Content   string    `gorm:"type:text" json:"content"`
    Summary   string    `gorm:"size:500" json:"summary"`
    Status    int       `gorm:"default:1" json:"status"` // 1:发布 0:草稿
    ViewCount int       `gorm:"default:0" json:"view_count"`
    UserID    uint      `gorm:"not null" json:"user_id"`
    User      User      `gorm:"foreignKey:UserID" json:"user,omitempty"`
    Comments  []Comment `gorm:"foreignKey:PostID" json:"comments,omitempty"`
}

// Comment 评论模型
type Comment struct {
    BaseModel
    Content string `gorm:"type:text;not null" json:"content"`
    Status  int    `gorm:"default:1" json:"status"` // 1:正常 0:隐藏
    UserID  uint   `gorm:"not null" json:"user_id"`
    PostID  uint   `gorm:"not null" json:"post_id"`
    User    User   `gorm:"foreignKey:UserID" json:"user,omitempty"`
    Post    Post   `gorm:"foreignKey:PostID" json:"post,omitempty"`
}</code></pre>

                        <h3>模型方法</h3>
                        <pre><code class="language-go">// TableName 自定义表名
func (User) TableName() string {
    return "users"
}

// BeforeCreate 创建前钩子
func (u *User) BeforeCreate(tx *gorm.DB) error {
    // 密码加密
    if u.Password != "" {
        hashedPassword, err := bcrypt.GenerateFromPassword([]byte(u.Password), bcrypt.DefaultCost)
        if err != nil {
            return err
        }
        u.Password = string(hashedPassword)
    }
    return nil
}

// AfterFind 查询后钩子
func (u *User) AfterFind(tx *gorm.DB) error {
    // 可以在这里做一些后处理
    return nil
}

// CheckPassword 验证密码
func (u *User) CheckPassword(password string) bool {
    err := bcrypt.CompareHashAndPassword([]byte(u.Password), []byte(password))
    return err == nil
}</code></pre>

                        <h2>数据库操作</h2>

                        <h3>基础CRUD操作</h3>
                        <pre><code class="language-go">package services

import (
    "errors"
    "gorm.io/gorm"
)

// UserService 用户服务
type UserService struct {
    db *gorm.DB
}

// NewUserService 创建用户服务
func NewUserService(db *gorm.DB) *UserService {
    return &UserService{db: db}
}

// Create 创建用户
func (s *UserService) Create(user *User) error {
    return s.db.Create(user).Error
}

// GetByID 根据ID获取用户
func (s *UserService) GetByID(id uint) (*User, error) {
    var user User
    err := s.db.First(&user, id).Error
    if err != nil {
        if errors.Is(err, gorm.ErrRecordNotFound) {
            return nil, errors.New("用户不存在")
        }
        return nil, err
    }
    return &user, nil
}

// GetByEmail 根据邮箱获取用户
func (s *UserService) GetByEmail(email string) (*User, error) {
    var user User
    err := s.db.Where("email = ?", email).First(&user).Error
    if err != nil {
        return nil, err
    }
    return &user, nil
}

// Update 更新用户
func (s *UserService) Update(user *User) error {
    return s.db.Save(user).Error
}

// Delete 删除用户
func (s *UserService) Delete(id uint) error {
    return s.db.Delete(&User{}, id).Error
}

// List 获取用户列表
func (s *UserService) List(page, pageSize int) ([]User, int64, error) {
    var users []User
    var total int64
    
    // 计算总数
    s.db.Model(&User{}).Count(&total)
    
    // 分页查询
    offset := (page - 1) * pageSize
    err := s.db.Offset(offset).Limit(pageSize).Find(&users).Error
    
    return users, total, err
}</code></pre>

                        <h3>复杂查询</h3>
                        <pre><code class="language-go">// GetPostsWithUser 获取文章及作者信息
func (s *PostService) GetPostsWithUser(page, pageSize int) ([]Post, error) {
    var posts []Post
    offset := (page - 1) * pageSize
    
    err := s.db.Preload("User").
        Where("status = ?", 1).
        Order("created_at desc").
        Offset(offset).
        Limit(pageSize).
        Find(&posts).Error
        
    return posts, err
}

// SearchPosts 搜索文章
func (s *PostService) SearchPosts(keyword string, page, pageSize int) ([]Post, int64, error) {
    var posts []Post
    var total int64
    
    query := s.db.Model(&Post{}).Where("status = ?", 1)
    
    if keyword != "" {
        likeKeyword := "%" + keyword + "%"
        query = query.Where("title LIKE ? OR content LIKE ?", likeKeyword, likeKeyword)
    }
    
    // 计算总数
    query.Count(&total)
    
    // 分页查询
    offset := (page - 1) * pageSize
    err := query.Preload("User").
        Order("created_at desc").
        Offset(offset).
        Limit(pageSize).
        Find(&posts).Error
        
    return posts, total, err
}

// GetUserStats 获取用户统计信息
func (s *UserService) GetUserStats(userID uint) (map[string]interface{}, error) {
    var postCount int64
    var commentCount int64
    
    s.db.Model(&Post{}).Where("user_id = ?", userID).Count(&postCount)
    s.db.Model(&Comment{}).Where("user_id = ?", userID).Count(&commentCount)
    
    return map[string]interface{}{
        "post_count":    postCount,
        "comment_count": commentCount,
    }, nil
}</code></pre>

                        <h2>事务管理</h2>
                        <pre><code class="language-go">// CreatePostWithComment 创建文章并添加评论（事务）
func (s *PostService) CreatePostWithComment(post *Post, comment *Comment) error {
    return s.db.Transaction(func(tx *gorm.DB) error {
        // 创建文章
        if err := tx.Create(post).Error; err != nil {
            return err
        }
        
        // 设置评论的文章ID
        comment.PostID = post.ID
        
        // 创建评论
        if err := tx.Create(comment).Error; err != nil {
            return err
        }
        
        return nil
    })
}

// TransferPoints 积分转账（手动事务）
func (s *UserService) TransferPoints(fromUserID, toUserID uint, points int) error {
    tx := s.db.Begin()
    defer func() {
        if r := recover(); r != nil {
            tx.Rollback()
        }
    }()
    
    // 扣除发送方积分
    if err := tx.Model(&User{}).Where("id = ?", fromUserID).
        Update("points", gorm.Expr("points - ?", points)).Error; err != nil {
        tx.Rollback()
        return err
    }
    
    // 增加接收方积分
    if err := tx.Model(&User{}).Where("id = ?", toUserID).
        Update("points", gorm.Expr("points + ?", points)).Error; err != nil {
        tx.Rollback()
        return err
    }
    
    return tx.Commit().Error
}</code></pre>

                        <h2>数据库迁移</h2>
                        <pre><code class="language-go">package migrations

import (
    "gorm.io/gorm"
)

// Migration 迁移接口
type Migration interface {
    Up(*gorm.DB) error
    Down(*gorm.DB) error
}

// CreateUsersTable 创建用户表
type CreateUsersTable struct{}

func (m CreateUsersTable) Up(db *gorm.DB) error {
    return db.AutoMigrate(&User{})
}

func (m CreateUsersTable) Down(db *gorm.DB) error {
    return db.Migrator().DropTable(&User{})
}

// AddIndexToUsers 为用户表添加索引
type AddIndexToUsers struct{}

func (m AddIndexToUsers) Up(db *gorm.DB) error {
    return db.Exec("CREATE INDEX idx_users_email ON users(email)").Error
}

func (m AddIndexToUsers) Down(db *gorm.DB) error {
    return db.Exec("DROP INDEX idx_users_email ON users").Error
}

// RunMigrations 运行迁移
func RunMigrations(db *gorm.DB) error {
    migrations := []Migration{
        CreateUsersTable{},
        AddIndexToUsers{},
        // 添加更多迁移...
    }
    
    for _, migration := range migrations {
        if err := migration.Up(db); err != nil {
            return err
        }
    }
    
    return nil
}</code></pre>

                        <h2>控制器中的使用</h2>
                        <pre><code class="language-go">package controllers

import (
    "strconv"
)

// UserController 用户控制器
type UserController struct {
    mvc.BaseController
    userService *services.UserService
}

// NewUserController 创建用户控制器
func NewUserController() *UserController {
    return &UserController{
        userService: services.NewUserService(database.DB),
    }
}

// GetIndex 获取用户列表
func (c *UserController) GetIndex() {
    page, _ := strconv.Atoi(c.GetParam("page", "1"))
    pageSize, _ := strconv.Atoi(c.GetParam("pageSize", "10"))
    
    users, total, err := c.userService.List(page, pageSize)
    if err != nil {
        c.RenderError(500, "获取用户列表失败", err)
        return
    }
    
    c.SetData("Users", users)
    c.SetData("Total", total)
    c.SetData("Page", page)
    c.SetData("PageSize", pageSize)
    c.RenderHTML("user/index.html")
}

// PostCreate 创建用户
func (c *UserController) PostCreate() {
    var user User
    if err := c.BindJSON(&user); err != nil {
        c.RenderError(400, "参数错误", err)
        return
    }
    
    if err := c.userService.Create(&user); err != nil {
        c.RenderError(500, "创建用户失败", err)
        return
    }
    
    c.RenderJSON(map[string]interface{}{
        "message": "创建成功",
        "user":    user,
    })
}

// GetShow 获取用户详情
func (c *UserController) GetShow() {
    idStr := c.GetParam("id")
    id, err := strconv.ParseUint(idStr, 10, 32)
    if err != nil {
        c.RenderError(400, "参数错误", nil)
        return
    }
    
    user, err := c.userService.GetByID(uint(id))
    if err != nil {
        c.RenderError(404, "用户不存在", err)
        return
    }
    
    c.SetData("User", user)
    c.RenderHTML("user/show.html")
}</code></pre>

                        <h2>性能优化</h2>

                        <h3>1. 预加载关联</h3>
                        <div class="alert alert-info">
                            <ul class="mb-0">
                                <li>使用 <code>Preload</code> 避免 N+1 查询问题</li>
                                <li>合理使用 <code>Select</code> 只查询需要的字段</li>
                                <li>使用 <code>Joins</code> 进行连接查询</li>
                            </ul>
                        </div>

                        <h3>2. 数据库索引</h3>
                        <div class="alert alert-warning">
                            <ul class="mb-0">
                                <li>为经常查询的字段添加索引</li>
                                <li>复合索引要注意字段顺序</li>
                                <li>避免在小表上创建过多索引</li>
                            </ul>
                        </div>

                        <h3>3. 连接池优化</h3>
                        <div class="alert alert-success">
                            <ul class="mb-0">
                                <li>合理设置 MaxOpenConns 和 MaxIdleConns</li>
                                <li>设置合适的 ConnMaxLifetime</li>
                                <li>监控连接池使用情况</li>
                            </ul>
                        </div>

                        <h2>下一步</h2>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">
                                            <i class="fas fa-rocket text-primary"></i> 部署上线
                                        </h5>
                                        <p class="card-text">学习如何将应用部署到生产环境。</p>
                                        <a href="/home/deployment" class="btn btn-primary btn-sm">
                                            查看文档 <i class="fas fa-arrow-right"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">
                                            <i class="fas fa-layer-group text-success"></i> 中间件
                                        </h5>
                                        <p class="card-text">了解中间件的使用和自定义开发。</p>
                                        <a href="/home/middleware" class="btn btn-success btn-sm">
                                            查看文档 <i class="fas fa-arrow-right"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 页脚 -->
    <footer class="bg-dark text-white py-4 mt-5">
        <div class="container">
            <div class="text-center">
                <p class="mb-0">© 2025 元曜. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
</body>
</html>