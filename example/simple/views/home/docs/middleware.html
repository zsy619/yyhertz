<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}} - Hertz MVC框架</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/css/style.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.min.css" rel="stylesheet">
</head>
<body>
    {{template "head" .}}

    <div class="container-fluid mt-4">
        <div class="row">
            <!-- 侧边栏 -->
            <div class="col-lg-3 col-md-4">
                {{template "docs-sidebar" .}}
            </div>
            
            <!-- 主要内容 -->
            <div class="col-lg-9 col-md-8">
                <!-- 面包屑导航 -->
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/">首页</a></li>
                        <li class="breadcrumb-item"><a href="/home/docs">文档</a></li>
                        <li class="breadcrumb-item active">{{.Title}}</li>
                    </ol>
                </nav>

                <div class="card">
                    <div class="card-body">
                        <h1 class="card-title">
                            <i class="fas fa-layer-group text-primary"></i> 中间件
                        </h1>
                        
                        <p class="lead">中间件是Hertz MVC框架的重要组成部分，提供了请求处理的强大扩展机制。</p>

                        <h2>什么是中间件</h2>
                        <p>中间件是在HTTP请求到达控制器之前或响应返回给客户端之前执行的代码组件。它们可以用于：</p>
                        <ul>
                            <li>身份认证和授权</li>
                            <li>请求日志记录</li>
                            <li>错误恢复处理</li>
                            <li>跨域资源共享(CORS)</li>
                            <li>限流和防护</li>
                            <li>数据压缩</li>
                        </ul>

                        <h2>内置中间件</h2>
                        <p>Hertz MVC提供了多个开箱即用的中间件：</p>

                        <h3>日志中间件</h3>
                        <pre><code class="language-go">import (
    "github.com/zsy619/yyhertz/framework/middleware"
)

func main() {
    app := mvc.HertzApp
    
    // 添加日志中间件
    app.Use(middleware.LoggerMiddleware())
    
    app.Run(":8888")
}</code></pre>

                        <h3>恢复中间件</h3>
                        <p>用于捕获panic并恢复程序执行，防止服务器崩溃：</p>
                        <pre><code class="language-go">// 添加恢复中间件
app.Use(middleware.RecoveryMiddleware())</code></pre>

                        <h3>CORS中间件</h3>
                        <p>处理跨域资源共享：</p>
                        <pre><code class="language-go">// 添加CORS中间件
app.Use(middleware.CORSMiddleware())</code></pre>

                        <h3>认证中间件</h3>
                        <pre><code class="language-go">// 添加认证中间件
app.Use(middleware.AuthMiddleware())</code></pre>

                        <h2>全局中间件</h2>
                        <p>全局中间件会应用到所有路由：</p>
                        <pre><code class="language-go">func main() {
    app := mvc.HertzApp
    
    // 全局中间件
    app.Use(
        middleware.LoggerMiddleware(),
        middleware.RecoveryMiddleware(),
        middleware.CORSMiddleware(),
    )
    
    // 控制器注册
    homeController := &HomeController{}
    app.AutoRouters(homeController)
    
    app.Run(":8888")
}</code></pre>

                        <h2>路由级中间件</h2>
                        <p>为特定路由或路由组添加中间件：</p>

                        <h3>命名空间中间件</h3>
                        <pre><code class="language-go">// API命名空间，带认证中间件
nsApi := mvc.NewNamespace("/api",
    // 在命名空间级别添加中间件
    mvc.NSMiddleware(middleware.AuthMiddleware()),
    
    mvc.NSRouter("/profile", userController, "GET:GetProfile"),
    mvc.NSRouter("/settings", userController, "PUT:PutSettings"),
)

mvc.AddNamespace(nsApi)</code></pre>

                        <h3>多个中间件</h3>
                        <pre><code class="language-go">// 管理员路由组，需要认证和管理员权限
adminGroup := mvc.NewNamespace("/admin",
    mvc.NSMiddleware(
        middleware.AuthMiddleware(),
        middleware.AdminMiddleware(),
        middleware.RateLimitMiddleware(),
    ),
    mvc.NSRouter("/dashboard", adminController, "GET:GetDashboard"),
    mvc.NSRouter("/users", adminController, "GET:GetUsers"),
)</code></pre>

                        <h2>自定义中间件</h2>
                        <h3>创建基础中间件</h3>
                        <pre><code class="language-go">package middleware

import (
    "context"
    "log"
    "time"
    
    "github.com/cloudwego/hertz/pkg/app"
)

// 自定义中间件示例
func CustomMiddleware() app.HandlerFunc {
    return func(ctx context.Context, c *app.RequestContext) {
        // 请求前处理
        start := time.Now()
        
        // 调用下一个处理器
        c.Next(ctx)
        
        // 请求后处理
        duration := time.Since(start)
        log.Printf("请求处理时间: %v", duration)
    }
}</code></pre>

                        <h3>带配置的中间件</h3>
                        <pre><code class="language-go">// 限流中间件
func RateLimitMiddleware(limit int, window time.Duration) app.HandlerFunc {
    return func(ctx context.Context, c *app.RequestContext) {
        // 获取客户端IP
        clientIP := c.ClientIP()
        
        // 实现限流逻辑
        if isRateLimited(clientIP, limit, window) {
            c.JSON(429, map[string]any{
                "error": "请求过于频繁，请稍后再试",
            })
            c.Abort()
            return
        }
        
        c.Next(ctx)
    }
}

// 使用示例
app.Use(RateLimitMiddleware(100, time.Minute))</code></pre>

                        <h3>认证中间件实现</h3>
                        <pre><code class="language-go">func AuthMiddleware() app.HandlerFunc {
    return func(ctx context.Context, c *app.RequestContext) {
        // 获取认证头
        token := string(c.GetHeader("Authorization"))
        if token == "" {
            token = c.Query("token")
        }
        
        if token == "" {
            c.JSON(401, map[string]any{
                "error": "缺少认证令牌",
            })
            c.Abort()
            return
        }
        
        // 验证令牌
        userID, err := validateToken(token)
        if err != nil {
            c.JSON(401, map[string]any{
                "error": "无效的认证令牌",
            })
            c.Abort()
            return
        }
        
        // 将用户信息存储到上下文
        c.Set("userID", userID)
        c.Next(ctx)
    }
}</code></pre>

                        <h2>中间件执行顺序</h2>
                        <p>中间件的执行顺序遵循以下规则：</p>
                        <pre><code class="language-go">func main() {
    app := mvc.HertzApp
    
    // 1. 全局中间件（按注册顺序执行）
    app.Use(middleware.LoggerMiddleware())     // 第一个执行
    app.Use(middleware.RecoveryMiddleware())   // 第二个执行
    app.Use(middleware.CORSMiddleware())       // 第三个执行
    
    // 2. 命名空间中间件
    nsApi := mvc.NewNamespace("/api",
        mvc.NSMiddleware(middleware.AuthMiddleware()), // 在命名空间内第一个执行
        mvc.NSMiddleware(middleware.RateLimitMiddleware()), // 第二个执行
        
        mvc.NSRouter("/users", userController, "GET:GetIndex"),
    )
    
    mvc.AddNamespace(nsApi)
    app.Run(":8888")
}</code></pre>

                        <h2>中间件最佳实践</h2>

                        <h3>错误处理中间件</h3>
                        <pre><code class="language-go">func ErrorHandleMiddleware() app.HandlerFunc {
    return func(ctx context.Context, c *app.RequestContext) {
        defer func() {
            if err := recover(); err != nil {
                log.Printf("Panic recovered: %v", err)
                
                c.JSON(500, map[string]any{
                    "error": "服务器内部错误",
                    "code":  "INTERNAL_ERROR",
                })
            }
        }()
        
        c.Next(ctx)
    }
}</code></pre>

                        <h3>请求ID中间件</h3>
                        <pre><code class="language-go">import (
    "github.com/google/uuid"
)

func RequestIDMiddleware() app.HandlerFunc {
    return func(ctx context.Context, c *app.RequestContext) {
        // 生成请求ID
        requestID := uuid.New().String()
        
        // 设置到响应头
        c.Header("X-Request-ID", requestID)
        
        // 存储到上下文
        c.Set("requestID", requestID)
        
        c.Next(ctx)
    }
}</code></pre>

                        <h3>安全头中间件</h3>
                        <pre><code class="language-go">func SecurityHeadersMiddleware() app.HandlerFunc {
    return func(ctx context.Context, c *app.RequestContext) {
        // 设置安全相关头部
        c.Header("X-Content-Type-Options", "nosniff")
        c.Header("X-Frame-Options", "DENY")
        c.Header("X-XSS-Protection", "1; mode=block")
        c.Header("Strict-Transport-Security", "max-age=31536000; includeSubDomains")
        
        c.Next(ctx)
    }
}</code></pre>

                        <h2>条件中间件</h2>
                        <pre><code class="language-go">// 仅在生产环境启用的中间件
func ConditionalMiddleware(env string) app.HandlerFunc {
    return func(ctx context.Context, c *app.RequestContext) {
        if env == "production" {
            // 生产环境特有的处理逻辑
            c.Header("X-Environment", "production")
        }
        
        c.Next(ctx)
    }
}

// 使用示例
if os.Getenv("ENV") == "production" {
    app.Use(ConditionalMiddleware("production"))
}</code></pre>

                        <h2>完整示例</h2>
                        <pre><code class="language-go">package main

import (
    "github.com/zsy619/yyhertz/framework/mvc"
    "github.com/zsy619/yyhertz/framework/middleware"
    "github.com/zsy619/yyhertz/example/simple/controllers"
)

func main() {
    app := mvc.HertzApp
    
    // 全局中间件
    app.Use(
        middleware.LoggerMiddleware(),
        middleware.RecoveryMiddleware(),
        middleware.CORSMiddleware(),
        RequestIDMiddleware(),
        SecurityHeadersMiddleware(),
    )
    
    // 控制器实例
    homeController := &controllers.HomeController{}
    userController := &controllers.UserController{}
    adminController := &controllers.AdminController{}
    
    // 公开路由
    app.AutoRouters(homeController)
    
    // API v1 - 需要认证
    nsApiV1 := mvc.NewNamespace("/api/v1",
        mvc.NSMiddleware(
            middleware.AuthMiddleware(),
            RateLimitMiddleware(100, time.Minute),
        ),
        
        // 用户相关API
        mvc.NSNamespace("/users",
            mvc.NSRouter("/", userController, "GET:GetIndex"),
            mvc.NSRouter("/", userController, "POST:PostCreate"),
            mvc.NSRouter("/:id", userController, "GET:GetShow"),
            mvc.NSRouter("/:id", userController, "PUT:PutUpdate"),
            mvc.NSRouter("/:id", userController, "DELETE:DeleteRemove"),
        ),
    )
    
    // 管理员API - 需要认证和管理员权限
    nsAdmin := mvc.NewNamespace("/admin",
        mvc.NSMiddleware(
            middleware.AuthMiddleware(),
            middleware.AdminMiddleware(),
            RateLimitMiddleware(50, time.Minute),
        ),
        mvc.NSAutoRouter(adminController),
    )
    
    // 注册命名空间
    mvc.AddNamespace(nsApiV1)
    mvc.AddNamespace(nsAdmin)
    
    app.Run(":8888")
}</code></pre>

                        <div class="alert alert-info">
                            <h5><i class="fas fa-lightbulb"></i> 中间件最佳实践</h5>
                            <ul class="mb-0">
                                <li>保持中间件功能单一，职责明确</li>
                                <li>合理安排中间件执行顺序</li>
                                <li>在生产环境中使用压缩和缓存中间件</li>
                                <li>为API添加限流和认证中间件</li>
                                <li>使用恢复中间件防止服务器崩溃</li>
                                <li>记录详细的请求日志用于调试</li>
                            </ul>
                        </div>

                        <h2>下一步</h2>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">
                                            <i class="fas fa-file-code text-primary"></i> 模板引擎
                                        </h5>
                                        <p class="card-text">学习模板的使用和数据绑定。</p>
                                        <a href="/home/template" class="btn btn-primary btn-sm">
                                            查看文档 <i class="fas fa-arrow-right"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">
                                            <i class="fas fa-cogs text-success"></i> 控制器
                                        </h5>
                                        <p class="card-text">回顾控制器的创建和使用方法。</p>
                                        <a href="/home/controller" class="btn btn-success btn-sm">
                                            查看文档 <i class="fas fa-arrow-right"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 页脚 -->
    <footer class="bg-dark text-white py-4 mt-5">
        <div class="container">
            <div class="text-center">
                <p class="mb-0">© 2025 元曜. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
</body>
</html>
